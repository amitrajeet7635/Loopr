# Loopr Backend - Solana Smart ContractsThis is the backend for Loopr, built with Rust and the Anchor framework for Solana. It handles subscription management, payment processing, QR code payments, and automated recurring payments.## ğŸ—ï¸ ArchitectureThe backend consists of:- **Smart Contracts** (Rust/Anchor): Core subscription and payment logic- **State Management**: Plans, subscriptions, payment records, and payment intents- **QR Code Flow**: Payment intents for mobile app integration- **Automated Payments**: Clockwork integration for recurring payments- **Testing Suite**: Comprehensive tests for all functionality## ğŸ“ Project Structure```Loopr-Backend/â”œâ”€â”€ programs/â”‚   â””â”€â”€ loopr-subscription/â”‚       â”œâ”€â”€ src/â”‚       â”‚   â”œâ”€â”€ lib.rs              # Main program entry pointâ”‚       â”‚   â”œâ”€â”€ state.rs            # Account state definitionsâ”‚       â”‚   â”œâ”€â”€ errors.rs           # Custom error definitionsâ”‚       â”‚   â””â”€â”€ instructions/       # Instruction handlersâ”‚       â”‚       â”œâ”€â”€ initialize_subscription_plan.rsâ”‚       â”‚       â”œâ”€â”€ create_subscription.rsâ”‚       â”‚       â”œâ”€â”€ process_payment.rsâ”‚       â”‚       â”œâ”€â”€ cancel_subscription.rsâ”‚       â”‚       â”œâ”€â”€ update_subscription_plan.rsâ”‚       â”‚       â”œâ”€â”€ automated_payment.rsâ”‚       â”‚       â”œâ”€â”€ initialize_payment_thread.rsâ”‚       â”‚       â”œâ”€â”€ create_payment_intent.rsâ”‚       â”‚       â”œâ”€â”€ subscribe_and_pay.rsâ”‚       â”‚       â”œâ”€â”€ confirm_payment.rsâ”‚       â”‚       â””â”€â”€ initialize_global_state.rsâ”‚       â””â”€â”€ Cargo.tomlâ”œâ”€â”€ tests/                          # Test filesâ”œâ”€â”€ scripts/                        # Utility scriptsâ”œâ”€â”€ Anchor.toml                     # Anchor configurationâ”œâ”€â”€ Cargo.toml                      # Workspace configurationâ””â”€â”€ package.json                    # Node.js dependencies```## ğŸš€ Core Features### 1. Subscription Management- Create and manage subscription plans- User subscription lifecycle- Plan updates and modifications- Subscription cancellation### 2. Payment Processing- Manual payments- Automated recurring payments (Clockwork)- Payment verification and records- SOL-based transactions### 3. QR Code Payment Flow- Payment intent creation for QR codes- Mobile app integration- One-time payment links- Expiration handling### 4. Security & Validation- Comprehensive error handling- Input validation- Authority checks- Program pause functionality## ğŸ”§ State Accounts### SubscriptionPlan```rustpub struct SubscriptionPlan {    pub authority: Pubkey,    pub plan_id: String,    pub name: String,    pub description: String,    pub price_per_period: u64,    pub period_duration: i64,    pub max_subscribers: Option<u32>,    pub current_subscribers: u32,    pub is_active: bool,    // ... timestamps and metadata}```### UserSubscription```rustpub struct UserSubscription {    pub user: Pubkey,    pub subscription_plan: Pubkey,    pub subscription_id: String,    pub is_active: bool,    pub next_payment_due: i64,    pub auto_pay_enabled: bool,    pub payment_thread: Option<Pubkey>,    // ... payment history and metadata}```### PaymentIntent (QR Code)```rustpub struct PaymentIntent {    pub intent_id: String,    pub plan_id: String,    pub payer: Option<Pubkey>,    pub amount: u64,    pub status: PaymentIntentStatus,    pub created_at: i64,    pub expires_at: i64,    // ... completion data}```## ğŸ¯ QR Code Payment Flow1. **Create Payment Intent**: Generate a payment intent with QR code data2. **QR Code Generation**: Frontend creates QR code from intent data3. **User Scans**: Loopr mobile app scans and processes the QR code4. **Payment Processing**: `subscribe_and_pay` instruction handles payment and subscription5. **Confirmation**: Payment intent marked as completed, subscription activated## ğŸ”„ Automated PaymentsIntegration with Clockwork for recurring payments:1. **Thread Initialization**: Set up payment thread for each subscription2. **Scheduled Execution**: Clockwork triggers payments at specified intervals3. **Balance Verification**: Check user balance before processing4. **Payment Processing**: Execute payment and update subscription5. **Error Handling**: Handle failed payments and subscription suspension## ğŸ› ï¸ Installation & SetupSee [QUICKSTART.md](./QUICKSTART.md) for detailed setup instructions.## ğŸ“ Usage Examples### Create a Subscription Plan```typescriptawait program.methods  .initializeSubscriptionPlan(    "netflix-premium",    "Netflix Premium",    "4K streaming with multiple screens",    new anchor.BN(0.1 * LAMPORTS_PER_SOL), // 0.1 SOL    new anchor.BN(30 * 24 * 60 * 60), // 30 days    1000 // max subscribers  )  .accounts({    subscriptionPlan: planPda,    globalState: globalStatePda,    authority: authority.publicKey,    systemProgram: SystemProgram.programId,  })  .rpc();```### Create Payment Intent (QR Code)```typescriptawait program.methods  .createPaymentIntent(    "intent-123",    "netflix-premium",    new anchor.BN(0.1 * LAMPORTS_PER_SOL),    new anchor.BN(Math.floor(Date.now() / 1000) + 3600) // 1 hour expiry  )  .accounts({    paymentIntent: intentPda,    subscriptionPlan: planPda,    authority: authority.publicKey,    globalState: globalStatePda,    systemProgram: SystemProgram.programId,  })  .rpc();```### Subscribe and Pay (QR Flow)```typescriptawait program.methods  .subscribeAndPay("subscription-123")  .accounts({    paymentIntent: intentPda,    subscriptionPlan: planPda,    userSubscription: subscriptionPda,    user: user.publicKey,    authority: authority.publicKey,    globalState: globalStatePda,    systemProgram: SystemProgram.programId,  })  .signers([user])  .rpc();```## ğŸ§ª TestingRun the test suite:```bashanchor test```Test specific flows:```bash# QR code payment flownpm run test -- --grep "QR Code Payment Flow"# Subscription managementnpm run test -- --grep "subscription"```## ğŸ”— Integration### Frontend Integration- Use the generated IDL for TypeScript types- Implement QR code generation using payment intent data- Handle payment confirmations and subscription status### Mobile App Integration- Scan QR codes to extract payment intent information- Use Solana wallet integration for payments- Call `subscribe_and_pay` instruction to complete flow### Web3 Wallet Integration- Support for Phantom, Solflare, and other Solana wallets- Transaction signing for payments and subscriptions- Balance checks and payment confirmations## ğŸš¨ Security Considerations- Always verify payment amounts match plan prices- Check subscription validity before processing payments- Implement proper authority checks for admin functions- Validate payment intent expiration times- Use secure randomness for generating IDs## ğŸ“š Additional Documentation- [QUICKSTART.md](./QUICKSTART.md) - Setup and deployment guide- [API Reference](./docs/api.md) - Detailed instruction documentation- [Integration Guide](./docs/integration.md) - Frontend and mobile integration## ğŸ¤ Contributing1. Fork the repository2. Create a feature branch3. Implement changes with tests4. Submit a pull request## ğŸ“„ LicenseMIT License - see LICENSE file for details.---**Built with â¤ï¸ for the Solana ecosystem**